<!DOCTYPE html>
<html lang="pl">
<head>
<base href="./">
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Kalkulator marÅ¼y â€“ listy materiaÅ‚owe (v5)</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#ffffff; --card:#f7f7f8; --text:#111; --muted:#666; --line:#e6e6e6;
    --primary:#2563eb; --ok:#16a34a; --warn:#d97706; --danger:#b91c1c;
    --shadow:0 10px 30px rgba(0,0,0,.06);
  }
  .dark:root{
    --bg:#0b1220; --card:#0f1420; --text:#e6eef8; --muted:#9db2cf; --line:#1d2740;
    --primary:#3b82f6; --ok:#22c55e; --warn:#f59e0b; --danger:#ef4444;
    --shadow:0 12px 40px rgba(0,0,0,.35);
  }
  *{box-sizing:border-box}
  body{margin:0; font-family:Montserrat,system-ui,-apple-system,Segoe UI,Roboto,Arial; background:var(--bg); color:var(--text)}
  header{position:sticky; top:0; z-index:20; backdrop-filter:saturate(180%) blur(8px);
    background:color-mix(in oklab, var(--bg) 82%, transparent); border-bottom:1px solid var(--line)}
  .wrap{max-width:1200px; margin:0 auto; padding:16px}
  h1{font-size:20px; margin:0 0 4px}
  .sub{color:var(--muted); font-size:13px}
  .topbar{display:flex; gap:12px; align-items:center; justify-content:space-between; flex-wrap:wrap}
  .row{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
  .card{background:var(--card); border:1px solid var(--line); border-radius:16px; padding:16px; box-shadow:var(--shadow)}
  button, input, select, textarea{font-family:inherit; font-size:14px}
  button{border:1px solid var(--line); background:#fff; color:#111; padding:10px 14px; border-radius:12px; cursor:pointer}
  .dark button{background:#0f1420; color:var(--text)}
  button.primary{background:var(--primary); color:white; border-color:transparent}
  button.ghost{background:transparent}
  button:disabled{opacity:.6; cursor:not-allowed}
  .tag{font-size:12px; padding:6px 10px; border:1px solid var(--line); border-radius:999px; background:transparent}
  .ratebox{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
  .ratebox input{width:110px; padding:10px 12px; border-radius:12px; border:1px solid var(--line); background:transparent; color:var(--text)}
  .tabs{display:flex; gap:8px; margin:16px 0}
  .tab{padding:10px 14px; border:1px solid var(--line); border-radius:12px; cursor:pointer; background:transparent}
  .tab.active{background:var(--primary); color:#fff; border-color:transparent}
  .toolbar{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
  .toolbar select, .toolbar input[type="text"]{padding:10px 12px; border-radius:12px; border:1px solid var(--line); background:transparent; color:var(--text)}
  table{width:100%; border-collapse:collapse; font-size:13px}
  th,td{border-bottom:1px solid var(--line); padding:8px 6px; text-align:left; vertical-align:middle}
  thead th{position:sticky; top:var(--stickyTop); background:var(--card); z-index:10}
  td input, td textarea{
    width:100%; padding:8px 10px; border:1px solid var(--line);
    border-radius:8px; background:transparent; color:var(--text)
  }
  td textarea{resize:vertical; min-height:40px}
  .section{margin:16px 0}
  .section h2{font-size:16px; margin:0 0 10px}
  .pill{display:inline-flex; align-items:center; gap:8px; padding:8px 10px; border:1px solid var(--line); border-radius:999px}
  .kbd{font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; border:1px solid var(--line); padding:2px 6px; border-radius:6px; font-size:12px}
  .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;}
  .small{font-size:12px}
  .hint{font-size:12px; color:var(--muted)}
  .ok{color:var(--ok)}
  .danger{color:var(--danger)}
  .right{margin-left:auto}
  .grid{display:grid; gap:12px}
  .grid.cols-2{grid-template-columns:1fr 1fr}
  .grid.cols-3{grid-template-columns:repeat(3,1fr)}
  .grid.cols-4{grid-template-columns:repeat(4,1fr)}
</style>
</head>
<body>
<header>
  <div class="wrap topbar">
    <div>
      <h1>Kalkulator marÅ¼y â€“ listy materiaÅ‚owe</h1>
      <div class="sub">Tryb online (GitHub Pages). Dane zapisujÄ… siÄ™ w przeglÄ…darce (localStorage).</div>
    </div>
    <div class="row">
      <button id="btnTheme" class="ghost" title="PrzeÅ‚Ä…cz motyw">ðŸŒ“ Motyw</button>
      <a class="tag" href="#" id="rateStamp">Kurs: â€”</a>
      <button id="btnFetch" class="primary">Pobierz kursy</button>
    </div>
  </div>
</header>

<main class="wrap">
  <div class="section card">
    <div class="toolbar">
      <label>Lista:
        <select id="listSelect"></select>
      </label>
      <input id="listName" type="text" placeholder="Nazwa listy" />
      <button id="btnNewList">+ Nowa lista</button>
      <button id="btnDeleteList" class="danger">UsuÅ„ listÄ™</button>
      <span class="right hint">Wszystko zapisuje siÄ™ automatycznie</span>
    </div>

    <div class="tabs">
      <div class="tab active" data-tab="bom">Lista materiaÅ‚owa</div>
      <div class="tab" data-tab="analysis">Analiza / marÅ¼a</div>
    </div>

    <section id="tab-bom" class="section">
      <div class="grid cols-4">
        <div><span class="small">Kurs USDâ†’PLN</span><input id="rateUSD" type="number" step="0.0001" placeholder="4.0000" /></div>
        <div><span class="small">Kurs EURâ†’PLN</span><input id="rateEUR" type="number" step="0.0001" placeholder="4.3000" /></div>
        <div class="ratebox"><span class="small">Å¹rÃ³dÅ‚o kursÃ³w:</span><span class="tag mono">NBP</span></div>
      </div>

      <div class="section">
        <table id="tbl">
          <thead>
            <tr>
              <th style="width:22ch">Nazwa materiaÅ‚u</th>
              <th>Nr czÄ™Å›ci</th>
              <th>Dostawca</th>
              <th style="width:10ch">IloÅ›Ä‡</th>
              <th style="width:14ch">USD/szt</th>
              <th style="width:14ch">EUR/szt</th>
              <th style="width:14ch">PLN/szt</th>
              <th>WartoÅ›Ä‡ PLN</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="rows"></tbody>
          <tfoot>
            <tr>
              <td colspan="7" style="text-align:right">Suma materiaÅ‚Ã³w (PLN)</td>
              <td class="mono" id="sumPLN">0.00</td>
              <td></td>
            </tr>
          </tfoot>
        </table>
        <div class="row" style="margin-top:12px">
          <button id="btnAdd">+ Dodaj wiersz</button>
          <button id="btnClear">WyczyÅ›Ä‡ listÄ™</button>
          <span class="hint">Ceny z dokÅ‚adnoÅ›ciÄ… do 2 miejsc po przecinku.</span>
        </div>
      </div>
    </section>

    <section id="tab-analysis" class="section" hidden>
      <div class="grid cols-3">
        <div>
          <span class="small">Koszt importu (PLN)</span>
          <input id="costImport" type="number" step="0.01" placeholder="0.00" />
        </div>
        <div>
          <span class="small">Koszt eksportu (PLN)</span>
          <input id="costExport" type="number" step="0.01" placeholder="0.00" />
        </div>
        <div></div>
      </div>

      <div class="grid cols-3" style="margin-top:12px">
        <div>
          <span class="small">Wpisz marÅ¼Ä™ %</span>
          <input id="marginPct" type="number" step="0.01" placeholder="0.00" />
        </div>
        <div>
          <span class="small">â€¦lub wpisz cenÄ™ sprzedaÅ¼y (PLN)</span>
          <input id="targetPrice" type="number" step="0.01" placeholder="0.00" />
        </div>
        <div class="pill">Ostatnio edytowano: <span id="lastEdit" class="mono">â€”</span></div>
      </div>

      <div class="grid cols-3" style="margin-top:12px">
        <div class="card">
          <div class="small">Suma kosztu (PLN)</div>
          <div class="mono" id="resCostPLN">0.00</div>
        </div>
        <div class="card">
          <div class="small">MarÅ¼a %</div>
          <div class="mono ok" id="resMarginPct">0.00%</div>
        </div>
        <div class="card">
          <div class="small">Cena sprzedaÅ¼y (PLN)</div>
          <div class="mono" id="resTargetPLN">0.00</div>
        </div>
      </div>

      <div class="grid cols-3" style="margin-top:12px">
        <div class="card">
          <div class="small">Suma materiaÅ‚Ã³w USD</div>
          <div class="mono" id="resMatUSD">0.00</div>
        </div>
        <div class="card">
          <div class="small">Suma materiaÅ‚Ã³w EUR</div>
          <div class="mono" id="resMatEUR">0.00</div>
        </div>
        <div class="card">
          <div class="small">Suma materiaÅ‚Ã³w PLN</div>
          <div class="mono" id="resMatPLN">0.00</div>
        </div>
      </div>
    </section>
  </div>
</main>

<script>
document.addEventListener('DOMContentLoaded', function(){
  // ======= STATE =======
  const DEFAULT_ROW = () => ({
    id: 'R' + Math.random().toString(36).slice(2,9),
    name:'', part:'', supplier:'', qty:1,
    unitUSD:0, unitEUR:0, unitPLN:0, lastEdited:'PLN'
  });

  const DEFAULT_LIST = () => ({
    id: 'L' + Math.random().toString(36).slice(2,9),
    name: 'Nowa lista',
    rows: [],
    analysis: {
      importPLN: 0, exportPLN: 0,
      marginPct: 0,          // tylko marÅ¼a
      targetPricePLN: 0      // cena sprzedaÅ¼y wpisana przez uÅ¼ytkownika
    }
  });

  const state = {
    lists: [],
    currentListId: null,
    rates: { USDPLN: null, EURPLN: null, asOf: null },
    theme: localStorage.getItem('theme') || 'light',
  };

  // ======= UTIL =======
  const $ = s => document.querySelector(s);
  const $$ = s => Array.from(document.querySelectorAll(s));
  const fmt = (n, d=2) => (isFinite(n) ? Number(n).toFixed(d) : '0.00');
  const round2 = n => Math.round((Number(n)||0) * 100) / 100;

  function save(){ try{ localStorage.setItem('kalk-marza-lists', JSON.stringify(state)); }catch(e){} }
  function load(){
    const raw = localStorage.getItem('kalk-marza-lists'); if(!raw) return;
    try{
      const data = JSON.parse(raw);
      if(Array.isArray(data.lists)) state.lists = data.lists;
      if(data.currentListId) state.currentListId = data.currentListId;
      if(data.rates) state.rates = data.rates;
      if(data.theme) state.theme = data.theme;
    }catch(e){ console.warn('Nie udaÅ‚o siÄ™ wczytaÄ‡ danych z localStorage', e); }
  }

  function uid(){ return Math.random().toString(36).slice(2,9); }

  // ======= KURSY NBP =======
  async function fetchNBPRates(){
    const btn = $('#btnFetch');
    btn.disabled = true; btn.textContent = 'Pobieram...';
    try{
      const res = await fetch('https://api.nbp.pl/api/exchangerates/tables/A?format=json', {headers:{'Accept':'application/json'}});
      if(!res.ok) throw new Error('NBP HTTP '+res.status);
      const data = await res.json();
      const table = data?.[0];
      const rates = table?.rates || [];
      const USD = rates.find(r => r.code === 'USD');
      const EUR = rates.find(r => r.code === 'EUR');
      if(!USD || !EUR) throw new Error('Brak USD/EUR w odpowiedzi NBP');
      state.rates.USDPLN = Number(USD.mid);
      state.rates.EURPLN = Number(EUR.mid);
      state.rates.asOf = table?.effectiveDate || new Date().toISOString().slice(0,10);
      $('#rateUSD').value = state.rates.USDPLN;
      $('#rateEUR').value = state.rates.EURPLN;
      $('#rateStamp').textContent = `Kurs z: ${state.rates.asOf}`;
      save();
      recalcAll();
      updateAnalysis();
    }catch(err){
      alert('Nie udaÅ‚o siÄ™ pobraÄ‡ kursÃ³w NBP. Wpisz kursy rÄ™cznie.\n\nSzczegÃ³Å‚y: '+err.message);
    }finally{
      btn.disabled = false; btn.textContent = 'Pobierz kursy';
    }
  }

  // ======= LISTY: UI =======
  function refreshListSelect(){
    const sel = $('#listSelect');
    sel.innerHTML = '';
    state.lists.forEach(l=>{
      const opt = document.createElement('option');
      opt.value = l.id; opt.textContent = l.name || 'Bez nazwy';
      sel.appendChild(opt);
    });
    sel.value = state.currentListId || (state.lists[0]?.id || '');
    $('#listName').value = currentList()?.name || '';
  }

  function currentList(){ return state.lists.find(l=>l.id===state.currentListId); }

  function renderRows(){
    const tb = $('#rows'); tb.innerHTML = '';
    const cl = currentList(); if(!cl) return;
    const { USDPLN, EURPLN } = state.rates;

    cl.rows.forEach(row=>{
      const tr = document.createElement('tr');
      const cells = [
        `<td><textarea data-k="name" rows="2" placeholder="Opis materiaÅ‚u">${row.name||''}</textarea></td>`,
        `<td><input data-k="part" type="text" placeholder="Nr czÄ™Å›ci" value="${row.part||''}" /></td>`,
        `<td><input data-k="supplier" type="text" placeholder="Dostawca" value="${row.supplier||''}" /></td>`,
        `<td><input class="num" data-k="qty" type="number" min="0" step="1" value="${row.qty||1}"/></td>`,
        `<td><input class="num" data-k="unitUSD" type="number" step="0.01" value="${fmt(row.unitUSD||0)}"/></td>`,
        `<td><input class="num" data-k="unitEUR" type="number" step="0.01" value="${fmt(row.unitEUR||0)}"/></td>`,
        `<td><input class="num" data-k="unitPLN" type="number" step="0.01" value="${fmt(row.unitPLN||0)}"/></td>`,
        `<td class="mono">${fmt(toPLN(row, USDPLN, EURPLN))}</td>`,
        `<td><button data-act="del" class="ghost">UsuÅ„</button></td>`
      ];
      tr.innerHTML = cells.join('');
      tr.dataset.id = row.id;
      tb.appendChild(tr);
    });

    tb.addEventListener('input', onEdit, {once:true});
    tb.addEventListener('click', onClick, {once:true});

    updateSum();
  }

  function onEdit(e){
    const tr = e.target.closest('tr'); if(!tr) return;
    const id = tr.dataset.id; const k = e.target.dataset.k; if(!k) return;
    const cl = currentList(); const row = cl.rows.find(r=>r.id===id); if(!row) return;
    if(['qty','unitUSD','unitEUR','unitPLN'].includes(k)) row[k] = Number(e.target.value||0);
    else row[k] = e.target.value;

    if(['unitUSD','unitEUR','unitPLN'].includes(k)) row.lastEdited = k.replace('unit','');

    save();
    renderRows();
    updateAnalysis();
  }

  function onClick(e){
    if(e.target.dataset.act === 'del'){
      const id = e.target.closest('tr')?.dataset.id;
      const cl = currentList();
      cl.rows = cl.rows.filter(r=>r.id!==id);
      save();
      renderRows();
      updateAnalysis();
    }
  }

  function updateSum(){
    const cl = currentList(); if(!cl) return;
    const { USDPLN, EURPLN } = state.rates;
    const sum = cl.rows.reduce((acc,r)=> acc + toPLN(r, USDPLN, EURPLN), 0);
    $('#sumPLN').textContent = fmt(sum);
  }

  function toPLN(row, USDPLN, EURPLN){
    const qty = Number(row.qty||0);
    if(row.lastEdited==='USD' && USDPLN) return qty * Number(row.unitUSD||0) * USDPLN;
    if(row.lastEdited==='EUR' && EURPLN) return qty * Number(row.unitEUR||0) * EURPLN;
    if(row.lastEdited==='PLN') return qty * Number(row.unitPLN||0);

    // Gdy brak lastEdited â€” preferuj PLN, potem USD, potem EUR
    if(row.unitPLN) return qty * Number(row.unitPLN||0);
    if(row.unitUSD && USDPLN) return qty * Number(row.unitUSD||0) * USDPLN;
    if(row.unitEUR && EURPLN) return qty * Number(row.unitEUR||0) * EURPLN;
    return 0;
  }

  function convertPLNto(row, cur, USDPLN, EURPLN){
    const pln = Number(row.unitPLN||0);
    if(cur==='USD' && USDPLN) return pln / USDPLN;
    if(cur==='EUR' && EURPLN) return pln / EURPLN;
    return 0;
  }

  // ======= ANALIZA =======
  function updateAnalysis(){
    const cl = currentList(); if(!cl) return;

    const sumPLN = Number($('#sumPLN').textContent) || 0;
    const importPLN = Number($('#costImport').value || cl.analysis.importPLN || 0);
    const exportPLN = Number($('#costExport').value || cl.analysis.exportPLN || 0);
    let marginPct = ($('#marginPct').value !== '' ? Number($('#marginPct').value) : cl.analysis.marginPct || 0);
    let targetPLN = ($('#targetPrice').value !== '' ? Number($('#targetPrice').value) : cl.analysis.targetPricePLN || 0);

    const cost = sumPLN + importPLN + exportPLN;
    const lastEdit = updateAnalysis.lastEdit || 'margin';

    if(lastEdit === 'margin'){
      // uÅ¼ytkownik edytowaÅ‚ marÅ¼Ä™ â†’ wylicz cenÄ™ sprzedaÅ¼y
      targetPLN = cost * (1 + (marginPct/100));
    }else{
      // uÅ¼ytkownik edytowaÅ‚ cenÄ™ sprzedaÅ¼y â†’ wylicz marÅ¼Ä™
      marginPct = cost ? ((targetPLN - cost) / cost) * 100 : 0;
    }

    cl.analysis.importPLN = importPLN;
    cl.analysis.exportPLN = exportPLN;
    cl.analysis.marginPct = marginPct;
    cl.analysis.targetPricePLN = targetPLN;

    $('#resCostPLN').textContent = fmt(cost);
    $('#resMarginPct').textContent = fmt(marginPct, 2) + '%';
    $('#resTargetPLN').textContent = fmt(targetPLN);

    const { USDPLN, EURPLN } = state.rates;
    const sumUSD = USDPLN ? sumPLN / USDPLN : 0;
    const sumEUR = EURPLN ? sumPLN / EURPLN : 0;
    $('#resMatUSD').textContent = fmt(sumUSD);
    $('#resMatEUR').textContent = fmt(sumEUR);
    $('#resMatPLN').textContent = fmt(sumPLN);

    save();
  }

  // ======= WIÄ„ZANIA =======
  function wire(){
    $('#btnTheme').addEventListener('click', ()=>{
      state.theme = (state.theme==='light'?'dark':'light');
      save();
      applyTheme();
    });

    $('#btnFetch').addEventListener('click', fetchNBPRates);

    $('#btnAdd').addEventListener('click', ()=>{
      const cl = currentList(); if(!cl) return;
      cl.rows.push(DEFAULT_ROW());
      save();
      renderRows();
    });

    $('#btnClear').addEventListener('click', ()=>{
      const cl = currentList(); if(!cl) return;
      if(confirm('WyczyÅ›ciÄ‡ wszystkie wiersze tej listy?')){
        cl.rows = [];
        save();
        renderRows();
        updateAnalysis();
      }
    });

    $$('.tab').forEach(t=> t.addEventListener('click', ()=>{
      $$('.tab').forEach(x=>x.classList.remove('active'));
      t.classList.add('active');
      const name = t.dataset.tab;
      $('#tab-bom').hidden = name !== 'bom';
      $('#tab-analysis').hidden = name !== 'analysis';
      document.documentElement.style.setProperty('--stickyTop', name==='bom' ? 'calc(56px + 16px)' : '56px');
    }));

    $('#listSelect').addEventListener('change', (e)=>{
      state.currentListId = e.target.value;
      save();
      renderRows();
      updateAnalysis();
    });

    $('#listName').addEventListener('input', (e)=>{
      const cl = currentList(); if(!cl) return;
      cl.name = e.target.value;
      save();
      refreshListSelect();
    });

    $('#btnNewList').addEventListener('click', ()=>{
      const list = DEFAULT_LIST();
      list.name = 'Lista ' + (state.lists.length + 1);
      state.lists.push(list);
      state.currentListId = list.id;
      save();
      refreshListSelect();
      renderRows();
      updateAnalysis();
    });

    $('#btnDeleteList').addEventListener('click', ()=>{
      if(!state.currentListId) return;
      if(!confirm('UsunÄ…Ä‡ bieÅ¼Ä…cÄ… listÄ™?')) return;
      state.lists = state.lists.filter(l=>l.id!==state.currentListId);
      state.currentListId = state.lists[0]?.id || null;
      save();
      refreshListSelect();
      renderRows();
      updateAnalysis();
    });

    $('#costImport').addEventListener('input', ()=>{ updateAnalysis.lastEdit='margin'; updateAnalysis(); });
    $('#costExport').addEventListener('input', ()=>{ updateAnalysis.lastEdit='margin'; updateAnalysis(); });

    $('#marginPct').addEventListener('input', ()=>{ updateAnalysis.lastEdit='margin'; updateAnalysis(); });
    $('#targetPrice').addEventListener('input', ()=>{ updateAnalysis.lastEdit='price'; updateAnalysis(); });

    $('#rateUSD').addEventListener('input', ()=>{ state.rates.USDPLN = Number($('#rateUSD').value||0); save(); recalcAll(); updateAnalysis(); });
    $('#rateEUR').addEventListener('input', ()=>{ state.rates.EURPLN = Number($('#rateEUR').value||0); save(); recalcAll(); updateAnalysis(); });
  }

  function recalcAll(){ renderRows(); updateSum(); }

  function applyTheme(){
    if(state.theme==='dark') document.documentElement.classList.add('dark');
    else document.documentElement.classList.remove('dark');
  }

  // ======= INIT =======
  load();

  if(state.lists.length === 0){
    const list = DEFAULT_LIST();
    list.name = 'Lista 1';
    list.rows = [{ name:'', part:'', supplier:'', qty:1, unitUSD:0, unitEUR:0, unitPLN:0, lastEdited:'PLN' }];
    state.lists.push(list);
    state.currentListId = list.id;
  }else if(!state.currentListId){
    state.currentListId = state.lists[0].id;
  }

  refreshListSelect();
  wire();
  applyTheme();
  renderRows();

  if(state.rates?.USDPLN) $('#rateUSD').value = state.rates.USDPLN;
  if(state.rates?.EURPLN) $('#rateEUR').value = state.rates.EURPLN;
  if(state.rates?.asOf) $('#rateStamp').textContent = `Kurs z: ${state.rates.asOf}`;
  updateAnalysis();

  if(!state.rates?.USDPLN || !state.rates?.EURPLN){
    fetchNBPRates().catch(()=>{});
  }
});
</script>
</body>
</html>
